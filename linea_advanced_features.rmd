---
title: "LINEA"
output:
  html_document:
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 4  
    number_sections: false
    theme: flatly
    css: "style.css"

---

<div class='nav'><a href='index.html'>Home</a><a href='linea_getting_started.html'>Getting Started</a><a href='linea_additional_features.html'>Additional Features</a><a href='linea_advanced_features.html'>Advanced Features</a></div>

<hr>



<div class='dark_mode'>
  <label class="switch">
    <input type="checkbox" value="dark_mode" id="dark_mode">
    <span class="slider round"></span>    
  </label>
  <br>
  <strong>Dark Mode</strong>
</div>

<a class='github' href='https://github.com/paladinic/linea'>
  <img src='img/github_white.png'/>
  <strong>Fork it</strong>
</a>

<span class='logo_span second_logo'>LINEA</span>

<!--CONTENT-->

## Advanced Features

<span class='logo_span'>LINEA</span> is an R library aimed at simplifying and accelerating the development of linear models to understand the relationship between two or more variables. 

Linear models are commonly used in a variety of contexts including natural and social sciences, and various business applications (e.g. Marketing, Finance). 

This page covers a basic implementation of the `linea` library to analyse a time-series. We'll cover:

* [Non-linear Transformations](#Non-linear Transformations): What
* [Non-linear Models](#Non-linear Models): Importing data for this example.
* [Advanced Testing](#Advanced Testing): Running multiple models to quickly test different transformations.

We will run a simple model on some fictitious data sourced from Google trends. The aim of this exercise will be understand what variables seem to have an impact on the `ecommerce` variable.

### Non-linear Transformations

`linea` provides a few default *transformations*. These are mathematical functions meant to capture non linear relationships in the data. These functions are embedded in the library but are also available for use.

#### Decay

The `linea::decay()` function applies a decay by adding to each data point a percentage of the previous. 
This transformation is meant to capture the impact, over time, of an event.
This function only makes sense on time-bound models.

```{r, warning=F, message=FALSE}


raw_variable = data$online_media
dates = data$date

plot_ly() %>%
  add_lines(y = raw_variable, x = dates, name = 'raw') %>%
  add_lines(y = decay(raw_variable, decay = 0.5),
            x = dates,
            name = 'transformed: decay 50%') %>%
  add_lines(y = decay(raw_variable, decay = 0.75),
            x = dates,
            name = 'transformed: decay 75%') %>%
  add_lines(y = decay(raw_variable, decay = 0.95),
            x = dates,
            name = 'transformed: decay 95%') %>%
  layout(title = 'decay',
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```

<br>
<hr>

#### Diminish

The `linea::diminish()` function applies a negative exponential function:

$$\ 1 - e^{-v/m} $$

or..

$$\ 1- \frac{1}{e^{v/m}} $$
Where `v` is the vector to be transformed and `m` defines the shape of the transformation. Here is a visualization of the transformation.

```{r message=FALSE, warning=FALSE}

raw_variable = data$christmas
dates = data$date

plot_ly() %>%
  add_lines(y = raw_variable, x = dates, name = 'raw') %>%
  add_lines(
    y = diminish(raw_variable, m = 0.3, abs = F),
    x = dates,
    name = 'transformed: diminish 30%',
    yaxis = "y2"
  ) %>%
  layout(title = 'diminish',
         yaxis2 = list(overlaying = "y",
                       showgrid = F,
                       side = "right"), 
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```
<br>
<hr>
This transformation can also be visualized by placing the raw and transformed variable on the horizontal and vertical axis. 
```{r, warning=F, message=FALSE}

plot_ly() %>% 
  add_lines(
      x = raw_variable,
      y = diminish(raw_variable,.25,F),
      name = 'diminish 25%',
      line = list(shape = "spline")
    ) %>%   
  add_lines(
      x = raw_variable,
      y = diminish(raw_variable,.5,F),
      name = 'diminish 50%',
      line = list(shape = "spline")
    ) %>% 
  add_lines(
      x = raw_variable,
      y = diminish(raw_variable,.75,F),
      name = 'diminish 75%',
      line = list(shape = "spline")
    ) %>% 
  layout(title = 'raw vs. diminished', 
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```

```{r, warning=F, message=FALSE}

plot_ly() %>% 
  add_trace(
      x = raw_variable,
      y = diminish(raw_variable,.5,F)
    ) %>% 
  layout(title = 'raw vs. diminished (m = 10%)', 
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```

#### Hill

The `linea::hill_function()` function applies a negative exponential function by adding to each data point a percentage of the previous. 
This transformation is meant to capture relationships that exhibit diminishing returns.

```{r, warning=F, message=FALSE}

plot_ly() %>%
  add_lines(y = raw_variable, x = dates, name = 'raw') %>%
  add_lines(
    y = hill_function(raw_variable, m = 5,k = 25),
    x = dates,
    name = 'transformed: hill_function m = 5,k = 25',
    yaxis = "y2"
  ) %>%
  layout(title = 'diminish',
         yaxis2 = list(overlaying = "y",
                       showgrid = F,
                       side = "right"), 
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```
<br>
<hr>
This transformation can also be visualized by placing the raw and transformed variable on the horizontal and vertical axis. 
```{r, warning=F, message=FALSE}

plot_ly() %>% 
  add_trace(
      x = raw_variable,
      y = hill_function(raw_variable,m = 5,k = 25)
    ) %>% 
  layout(title = 'raw vs. hill_function m = 5,k = 25', 
         xaxis = list(showgrid = F),
         plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)")

```

#### Lag

The `linea::lag()` function applies a lag to the data. 
This transformation is meant to capture relationships that are lagged in time.
This function only makes sense on time-bound models.

```{r, warning=F, message=FALSE}

plot_ly() %>% 
  add_lines(y = raw_variable, x = dates, name = 'raw') %>%
  add_lines(
    y = lag(raw_variable, l = 1),
    x = dates,
    name = 'transformed: lag 1',
  ) %>%
  add_lines(
    y = lag(raw_variable, l = 5),
    x = dates,
    name = 'transformed: lag 5',
  ) %>%
  add_lines(
    y = lag(raw_variable, l = 10),
    x = dates,
    name = 'transformed: lag 10',
  )  %>% 
  layout(plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)",
         title = 'lag',
         xaxis = list(showgrid = F))

```
<br>
<hr>


#### Moving Average

The `linea::ma()` function applies a moving average to the data. 
This transformation is meant to capture relationships that are smoothed over time.
This function only makes sense on time-bound models.

```{r, warning=F, message=FALSE}

plot_ly() %>% 
  add_lines(y = raw_variable, x = dates, name = 'raw') %>%
  add_lines(
    y = ma(raw_variable, width = 5),
    x = dates,
    name = 'transformed: ma 5',
  ) %>%
  add_lines(
    y = ma(raw_variable, width = 15),
    x = dates,
    name = 'transformed: ma 15',
  ) %>% 
  add_lines(
    y = ma(raw_variable, width = 25),
    x = dates,
    name = 'transformed: ma 25',
  ) %>% 
  add_lines(
    y = ma(raw_variable, width = 25,align = 'left'),
    x = dates,
    name = 'transformed: lag 25 left',
  ) %>% 
  layout(plot_bgcolor  = "rgba(0, 0, 0, 0)",
         paper_bgcolor = "rgba(0, 0, 0, 0)",
         xaxis = list(showgrid = F),
         title='ma')

```
<br>
<hr>


### Non-linear Models

`linea` can capture non-linear relationships by applying transformations to the raw data, and then generating the regression for the transformed data. 
This can be accomplished using a model table which specifies each variable's transformation parameters. The function `linea::build_model_table()` can be used to generate the blank model table.

```{r, warning=F, message=FALSE}
model_table = build_model_table(ivs =  c('covid','christmas','trend'))

model_table %>%
  datatable(rownames = NULL,
            options = list(scrollX = T,
                           dom = "t"))
```

The model table can be written as a CSV or Excel and modified outside of R, or using dplyr as shown below. In this example the model run will apply the `linea::dim_rets()` function (with a parameter of 0.5, to the "covid" variable. 

```{r, warning=F, message=FALSE}
model_table = model_table %>%
  mutate(diminish = if_else(variable ==  'covid','10',diminish)) %>% 
  mutate(decay = if_else(variable ==  'covid','.5',decay))

model_table %>%
  datatable(rownames = NULL,
            options = list(scrollX = T,
                           dom = "t"))
```

The model table can be used as an input in the `linea::run_model()` function. The `linea::response_curves()` function will display the non-linear relationship capture by the model.

```{r, warning=F, message=FALSE}
model = run_model(data = data,
                  dv = 'ecommerce',
                  model_table = model_table)

model %>% 
  response_curves(
    x_min = 0,
    x_max = 30,
    y_min = 0,
    y_max = 20000,
    interval = 0.01
    )
```
<br>
<hr>

### Advanced Testing

#### Unused Variables

The function `linea::what_next()` can be used to run a model for each of the unused variables in the data. The function will run the current model specification with the additional unused variable. This will return a `data.frame` containing the statistics of each model run. 

```{r, warning=F, message=FALSE}
model %>% 
  what_next() %>% 
  datatable(rownames = NULL)
```

#### Parameter Tuning

Similarly, to find the right parameters for the non-linear relationship, the function `linea::what_trans()` can be used to run multiple models with a range of parameters. If parameters are passed for multiple transformations, the function will run models for all combinations. The inputs for this function are:

* the starting model
* a variable name, present in the data
* a table (i.e. trans_df) specifying the values of the parameters

The trans_df can be built as follows:

```{r, warning=F, message=FALSE}

trans_df = data.frame(
  name = c('diminish', 'decay', 'lag', 'ma'),
  func = c(
    'linea::diminish(x,a)',
    'linea::decay(x,a)',
    'linea::lag(x,a)',
    'linea::ma(x,a)'
  ),
  order = 1:4
) %>%
  dplyr::mutate(val = '') %>%
  dplyr::mutate(val = dplyr::if_else(condition = name == 'diminish',
                                     '0.5,1,10,100,1000',
                                     val))


trans_df %>% 
  datatable(rownames = NULL)

```

```{r, warning=F, message=FALSE}
model %>% 
  what_trans(trans_df = trans_df,
             variable ='offline_media') %>% 
  datatable(rownames = NULL)
```

## Next Steps

1. The <a href="linea_getting_started.html">Getting Started</a> page is a good place to start learning how to build linear models with `linea`.

2. The <a href="linea_additional_features.html">Additional Features</a> page all other functions of the library.



<footer class="footer_toc">
  <span>
    LINEA
  </span>
  by
  <a href="linea-r.org">
    linea-r.org
  </a>
  &copy;2022
</footer>